# Crypto Market Data Fetcher (Clean Architecture)

Small backend project to fetch and visualize crypto market data from external providers (starting with **CoinGecko**), using a clean, layered architecture.

Current focus: **BTC/ETH price history endpoint**, with proper separation of concerns and professional error handling.

---

## Architecture Overview

```
app/
 ├── 1-api/             # FastAPI routes + Pydantic models 
 ├── 2-business/        # Use cases (application / business logic) 
 ├── 3-domain/          # Domain entities (dataclasses, value objects) 
 ├── 4-infrastructure/  # External providers (CoinGecko client) 
 └── 5-tests/           # Unit / integration tests
```

---

## Domain Entities

```python
from enum import Enum
from datetime import datetime

class Symbol(str, Enum):
    BTC = "bitcoin"
    ETH = "ethereum"
    XRP = "ripple"

class Currency(str, Enum):
    USD = "usd"
    EUR = "eur"
    GBP = "gbp"
    AUD = "aud"
    CHF = "chf"
    JPY = "jpy"

class Provider(str, Enum):
    COINGECKO = "coingecko"


class PricePoint:
    timestamp: datetime
    price: float


class MarketChartData:
    symbol: Symbol
    currency: Currency
    points: list[PricePoint]
```

---

## API Pydantic Models

```python
from pydantic import BaseModel
from datetime import datetime

class PricePointResponse(BaseModel):
    timestamp: datetime
    price: float


class MarketChartDataResponse(BaseModel):
    symbol: Symbol
    currency: Currency
    points: list[PricePointResponse]


class MarketChartRequest(BaseModel):
    symbol: Symbol
    currency: Currency
    days: int
```

## Error Handling by Layer
This project follows a strict separation of responsibilities across layers.  
Each layer defines **its own errors**, translates errors from the layer below, and exposes a clean, consistent contract to the caller.

-   **Infrastructure Layer** → technical errors (network, timeouts, malformed JSON)
    
-   **Business Layer** → domain and semantic errors
    
-   **API Layer** → request validation + HTTP status mapping
    

----------

### Infrastructure Layer

**Responsibility:** communicate with the external provider (CoinGecko), handle network failures, and return raw JSON.

#### **Own/Input Errors (generated by this layer due to invalid input parameters)**

-   **`InfrastructureBadURL`**  
    Raised when the request cannot even be constructed due to technical issues such as:
    
    -   missing or empty URL
        
    -   missing token/auth required by the provider
        
    -   invalid configuration that makes the HTTP request impossible
        

#### **Received Errors (mapped from external libraries)**

-   **`InfrastructureExternalApiTimeout`**  
    ← `httpx.TimeoutException`  
    The request took too long and timed out.
    
-   **`InfrastructureExternalApiError`**  
    ← `httpx.RequestError` **or** non-2xx HTTP status  
    Any network error or failed HTTP response.
    
-   **`InfrastructureExternalApiMalformedResponse`**  
    ← JSON decoding failure (`response.json()` error)
    
----------

### Business Layer

**Responsibility:** apply domain rules, choose the provider, “open the box” of raw data, and convert raw → domain entities.

#### **Own/Input Errors**

-   **`BusinessValidationError`**  
    Input parameters are **invalid for the domain**, such as:
    
    -   `days ≤ 0`
        
    -   required parameters are empty
        
-   **`BusinessProviderNotCompatible`**  
    The provider does **not support** the requested `symbol/currency` combination.
    

#### **Received Errors (mapped from Infrastructure)**

-   **`BusinessProviderGeneralError`**  
    A generic provider failure from the perspective of the domain.  
    Raised when any of these infra errors occur:
    
    -   ← `InfrastructureExternalApiTimeout`
        
    -   ← `InfrastructureExternalApiError`
        
    -   ← `InfrastructureExternalApiMalformedResponse`
        
    -   ← `InfrastructureBadURL`
        

#### **Own/Process Errors**

-   **`BusinessMalformedDataError`**  
    The raw JSON structure is technically valid, but **does not match the domain’s expectations**  
    (e.g., `"prices"` key missing or not a list).
    
-   **`BusinessNoDataError`**  
    The structure is correct (e.g., `"prices"` exists), but the dataset is **empty** and the domain considers this an error.
    

----------

### API Layer

**Responsibility:** receive the HTTP request, validate it using Pydantic, call the business layer, and map errors to clean HTTP responses.

#### **Own/Input Errors**

-   **`RequestValidationError` (422)**  
    Generated automatically by FastAPI/Pydantic when the input does not match the contract:
    
    -   invalid enum values (`provider`, `symbol`, `currency`)
        
    -   wrong types (`days` not an int)
        
    -   missing or invalid fields
        

#### **Error Mapping (Business → HTTP)**

The API layer converts Business exceptions into proper HTTP status codes:

-   `BusinessValidationError`  
    → **422 Unprocessable Entity**
    
-   `BusinessProviderNotCompatible`  
    → **400 Bad Request**
    
-   `BusinessProviderGeneralError`  
    → **500 Internal Server Error**
    
-   `BusinessMalformedDataError`  
    → **500 Internal Server Error**
    
-   `BusinessNoDataError`  
    → **404 Not Found**
    

----------

## ✅ Summary

Each layer:

-   **raises only the errors it is responsible for**,
    
-   **translates errors from lower layers**,
    
-   and ensures the API exposes a **consistent, predictable** error contract to the client.

---

## How to Run

Use **uvicorn** to run the FastAPI app:

```bash
uvicorn app.main:app --reload
```

### Endpoints

- `GET /market-chart` — fetch historical market price data for a given symbol and currency.

